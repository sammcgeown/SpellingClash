{{define "list_detail.tmpl"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="/static/js/htmx.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <header class="dashboard-header">
                <h1>WordClash</h1>
                <div class="user-info">
                    <span>Welcome, {{.User.Name}}!</span>
                    <form method="POST" action="/logout" style="display: inline;">
                        <button type="submit" class="btn btn-secondary">Logout</button>
                    </form>
                </div>
            </header>

            <nav class="dashboard-nav">
                <a href="/parent/dashboard" class="nav-link">Dashboard</a>
                <a href="/parent/family" class="nav-link">Manage Families</a>
                <a href="/parent/kids" class="nav-link">Manage Kids</a>
                <a href="/parent/lists" class="nav-link active">Manage Lists</a>
            </nav>

    <main class="dashboard-main">
        <div class="page-header">
            <div>
                <a href="/parent/lists" class="back-link">‚Üê Back to Lists</a>
                <h2>{{.List.Name}}{{if .List.IsPublic}} <span class="public-badge">üìö Public</span>{{end}}</h2>
                {{if .List.Description}}
                <p class="list-description">{{.List.Description}}</p>
                {{end}}
            </div>
            {{if not .List.IsPublic}}
            <form method="POST" action="/parent/lists/{{.List.ID}}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this list and all its words?');">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <button type="submit" class="btn btn-danger">Delete List</button>
            </form>
            {{end}}
        </div>

        <div class="list-detail-grid">
            <!-- Words Section -->
            <div class="section-card">
                <div class="section-header">
                    <h3>Words ({{len .Words}})</h3>
                    {{if not .List.IsPublic}}
                    <div class="button-group">
                        <button class="btn btn-primary btn-sm" onclick="document.getElementById('add-word-form').style.display='block'; document.getElementById('bulk-add-form').style.display='none';">
                            + Add Word
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('bulk-add-form').style.display='block'; document.getElementById('add-word-form').style.display='none';">
                            üìã Bulk Add
                        </button>
                    </div>
                    {{end}}
                </div>

                {{if not .List.IsPublic}}
                <div id="add-word-form" class="inline-form" style="display:none;">
                    <form method="POST" action="/parent/lists/{{.List.ID}}/words/add">
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                        <div class="form-row">
                            <input type="text" name="word" placeholder="Enter word" required autofocus>
                            <select name="difficulty">
                                <option value="1">Easy</option>
                                <option value="2">Medium-Easy</option>
                                <option value="3" selected>Medium</option>
                                <option value="4">Medium-Hard</option>
                                <option value="5">Hard</option>
                            </select>
                        </div>
                        <div class="form-row" style="margin-top: 8px;">
                            <textarea name="definition" placeholder="Definition (optional)" rows="2" style="flex: 1; resize: vertical;"></textarea>
                        </div>
                        <div class="form-row" style="margin-top: 8px;">
                            <button type="submit" class="btn btn-primary btn-sm">Add</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('add-word-form').style.display='none'">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <div id="bulk-add-form" class="inline-form" style="display:none;">
                    <form method="POST" action="/parent/lists/{{.List.ID}}/words/bulk-add" id="bulk-import-form">
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                        <div class="form-group">
                            <label for="bulk-words">Paste words (comma-separated or one per line)</label>
                            <textarea name="words" id="bulk-words" rows="8" placeholder="e.g., cat, dog, bird&#10;or&#10;cat&#10;dog&#10;bird" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="bulk-difficulty">Difficulty for all words</label>
                            <select name="difficulty" id="bulk-difficulty">
                                <option value="1">Easy</option>
                                <option value="2">Medium-Easy</option>
                                <option value="3" selected>Medium</option>
                                <option value="4">Medium-Hard</option>
                                <option value="5">Hard</option>
                            </select>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div id="bulk-import-progress" style="display:none;">
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progress-bar-fill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progress-status">Processing...</span>
                                <span id="progress-count">0 / 0</span>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="bulk-add-submit">Add All Words</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('bulk-add-form').style.display='none'">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
                {{end}}

                {{if .Words}}
                <div class="words-list">
                    {{range .Words}}
                    <div class="word-item">
                        <div class="word-info">
                            <div>
                                <span class="word-text">{{.WordText}}</span>
                                <span class="difficulty-badge difficulty-{{.DifficultyLevel}}">
                                    {{if eq .DifficultyLevel 1}}Easy{{else if eq .DifficultyLevel 2}}Med-Easy{{else if eq .DifficultyLevel 3}}Medium{{else if eq .DifficultyLevel 4}}Med-Hard{{else}}Hard{{end}}
                                </span>
                            </div>
                            {{if .Definition}}
                            <div class="word-definition">{{.Definition}}</div>
                            {{end}}
                        </div>
                        {{if not $.List.IsPublic}}
                        <div class="word-actions">
                            <button type="button" class="btn btn-sm btn-link" onclick="document.getElementById('edit-word-{{.ID}}').style.display='block';">
                                ‚úèÔ∏è Edit
                            </button>
                            <form method="POST" action="/parent/lists/{{.SpellingListID}}/words/{{.ID}}/delete" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this word?');">√ó</button>
                            </form>
                        </div>
                        {{end}}
                    </div>
                    
                    {{if not $.List.IsPublic}}
                    <!-- Edit Word Form -->
                    <div id="edit-word-{{.ID}}" class="inline-form" style="display: none;">
                        <h4>Edit Word</h4>
                        <form method="POST" action="/parent/lists/{{.SpellingListID}}/words/{{.ID}}/update">
                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                            
                            <div class="form-group">
                                <label for="edit-word-text-{{.ID}}">Word:</label>
                                <input type="text" id="edit-word-text-{{.ID}}" name="word_text" value="{{.WordText}}" required class="form-input">
                            </div>

                            <div class="form-group">
                                <label for="edit-difficulty-{{.ID}}">Difficulty:</label>
                                <select id="edit-difficulty-{{.ID}}" name="difficulty" class="form-input">
                                    <option value="1" {{if eq .DifficultyLevel 1}}selected{{end}}>Easy</option>
                                    <option value="2" {{if eq .DifficultyLevel 2}}selected{{end}}>Med-Easy</option>
                                    <option value="3" {{if eq .DifficultyLevel 3}}selected{{end}}>Medium</option>
                                    <option value="4" {{if eq .DifficultyLevel 4}}selected{{end}}>Med-Hard</option>
                                    <option value="5" {{if eq .DifficultyLevel 5}}selected{{end}}>Hard</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="edit-definition-{{.ID}}">Definition (optional):</label>
                                <textarea id="edit-definition-{{.ID}}" name="definition" rows="2" class="form-input" placeholder="Optional: Add a definition instead of using a generated sentence">{{.Definition}}</textarea>
                                <small class="form-help">Leave blank to use an automatically generated sentence.</small>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('edit-word-{{.ID}}').style.display='none';">Cancel</button>
                            </div>
                        </form>
                    </div>
                    {{end}}
                    {{end}}
                </div>
                {{else}}
                <div class="empty-state-small">
                    <p>No words added yet.{{if not .List.IsPublic}} Add your first word to get started!{{end}}</p>
                </div>
                {{end}}
            </div>

            <!-- Assignments Section -->
            <div class="section-card">
                <h3>Assigned To</h3>

                {{if .FamilyKids}}
                <div class="assign-kids">
                    {{range $familyKid := $.FamilyKids}}
                    <div class="assign-kid-item">
                        <div class="kid-info-small">
                            <div class="kid-avatar-small" style="background-color: {{$familyKid.AvatarColor}}">
                                {{slice $familyKid.Name 0 1}}
                            </div>
                            <span>{{$familyKid.Name}}</span>
                        </div>

                        {{$isAssigned := false}}
                        {{range $.AssignedKids}}
                            {{if eq .ID $familyKid.ID}}
                                {{$isAssigned = true}}
                            {{end}}
                        {{end}}

                        {{if $isAssigned}}
                        <form method="POST" action="/parent/lists/{{$.List.ID}}/unassign/{{$familyKid.ID}}">
                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                            <button type="submit" class="btn btn-secondary btn-sm">Unassign</button>
                        </form>
                        {{else}}
                        <form method="POST" action="/parent/lists/{{$.List.ID}}/assign/{{$familyKid.ID}}">
                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                            <button type="submit" class="btn btn-primary btn-sm">Assign</button>
                        </form>
                        {{end}}
                    </div>
                    {{end}}
                </div>
                {{else}}
                <div class="empty-state-small">
                    <p>No kids in this family yet.</p>
                    <a href="/parent/kids" class="btn btn-primary btn-sm">Add Kids</a>
                </div>
                {{end}}
            </div>
            </div>
        </main>
        </div>
    </div>

    <script>
        // Handle bulk import with progress tracking
        document.getElementById('bulk-import-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const submitBtn = document.getElementById('bulk-add-submit');
            const progressDiv = document.getElementById('bulk-import-progress');
            const progressBar = document.getElementById('progress-bar-fill');
            const progressStatus = document.getElementById('progress-status');
            const progressCount = document.getElementById('progress-count');
            
            // Disable submit button and show progress
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            progressDiv.style.display = 'block';
            
            try {
                // Submit the form
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Failed to start import');
                }
                
                const data = await response.json();
                const progressId = data.progress_id;
                
                // Poll for progress
                const pollInterval = setInterval(async () => {
                    try {
                        const progressResponse = await fetch('/parent/lists/{{.List.ID}}/words/bulk-add/progress');
                        
                        if (!progressResponse.ok) {
                            clearInterval(pollInterval);
                            throw new Error('Failed to get progress');
                        }
                        
                        const progress = await progressResponse.json();
                        
                        // Update progress bar
                        const percentage = progress.total > 0 ? (progress.processed / progress.total * 100) : 0;
                        progressBar.style.width = percentage + '%';
                        progressCount.textContent = progress.processed + ' / ' + progress.total;
                        
                        if (progress.failed > 0) {
                            progressStatus.textContent = 'Processing (' + progress.failed + ' failed)...';
                        } else {
                            progressStatus.textContent = 'Processing...';
                        }
                        
                        // Check if completed
                        if (progress.completed) {
                            clearInterval(pollInterval);
                            
                            if (progress.error) {
                                progressStatus.textContent = 'Error: ' + progress.error;
                                progressStatus.style.color = 'red';
                                submitBtn.disabled = false;
                                submitBtn.textContent = 'Add All Words';
                            } else {
                                progressStatus.textContent = 'Complete!';
                                progressStatus.style.color = 'green';
                                
                                // Reload page after a short delay
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1000);
                            }
                        }
                    } catch (error) {
                        clearInterval(pollInterval);
                        console.error('Error polling progress:', error);
                        progressStatus.textContent = 'Error checking progress';
                        progressStatus.style.color = 'red';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add All Words';
                    }
                }, 500); // Poll every 500ms
                
            } catch (error) {
                console.error('Error starting import:', error);
                progressStatus.textContent = 'Error: ' + error.message;
                progressStatus.style.color = 'red';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add All Words';
            }
        });
    </script>
</body>
</html>
{{end}}
